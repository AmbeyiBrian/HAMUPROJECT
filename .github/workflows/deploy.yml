name: Deploy to Lightsail

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy backend via rsync
        run: |
          rsync -avz \
            -e "ssh -i ~/.ssh/lightsail_key" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'media/' \
            --exclude 'staticfiles/' \
            ./hamu_backend/ \
            ubuntu@${{ secrets.LIGHTSAIL_HOST }}:/home/myProject/hamu_backend/
            
      - name: Run post-deploy commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ubuntu
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            cd /home/myProject/hamu_backend
            source /home/myProject/hamu/bin/activate
            
            # Install dependencies
            pip install -r requirements.txt
            
            # Run migrations
            python manage.py migrate --noinput
            
            # Collect static files
            python manage.py collectstatic --noinput
            
            # Restart gunicorn
            sudo systemctl restart gunicorn
            
            echo "Backend deployment complete!"

  deploy-web:
    name: Deploy Web Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: hamu_web/package-lock.json
          
      - name: Install dependencies
        working-directory: ./hamu_web
        run: npm ci
        
      - name: Build React app
        working-directory: ./hamu_web
        run: npm run build
        env:
          CI: false
        
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy build to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/lightsail_key" \
            ./hamu_web/build/ \
            ubuntu@${{ secrets.LIGHTSAIL_HOST }}:/home/myProject/hamu_web/build/
            
      - name: Reload nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ubuntu
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            sudo systemctl reload nginx
            echo "Web deployment complete!"
